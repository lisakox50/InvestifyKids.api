import streamlit as st
from datetime import datetime

# ---------- Initialize session state ----------
if "registered" not in st.session_state:
    st.session_state.registered = False
if "name" not in st.session_state:
    st.session_state.name = ""
if "role" not in st.session_state:
    st.session_state.role = ""
if "portfolio" not in st.session_state:
    st.session_state.portfolio = {}  # symbol -> {"shares": int, "avg_price": float}
if "cash" not in st.session_state:
    st.session_state.cash = 10000.0  # start with 10k virtual cash
if "quests" not in st.session_state:
    st.session_state.quests = {
        "register": False,
        "first_stock": False,
        "learn_bond": False,
        "check_price": False,
    }

# ---------- Mock data ----------
FINANCIAL_TERMS = {
    "stock": "A stock is a share representing ownership in a company.",
    "bond": "A bond is a loan made by an investor to a borrower, like a company or government.",
    "fintech": "Fintech is financial technology, innovations improving financial services.",
    "dividend": "A dividend is a payment made by a company to its shareholders from profits.",
    "portfolio": "A portfolio is a collection of investments owned by an investor.",
}

MOCK_STOCK_PRICES = {
    "AAPL": 150.12,
    "TSLA": 700.45,
    "GOOG": 2800.99,
    "MSFT": 305.22,
    "AMZN": 3500.50,
    "F": 12.45,
}

# ---------- Functions ----------

def register_user(name: str, role: str):
    st.session_state.name = name.strip()
    st.session_state.role = role
    st.session_state.registered = True
    st.session_state.quests["register"] = True
    st.success(f"Welcome, {st.session_state.name}! You registered as a {st.session_state.role}.")

def explain_term(term: str) -> str:
    return FINANCIAL_TERMS.get(term.lower(), "Sorry, no explanation found for this term.")

def get_stock_price(symbol: str):
    symbol = symbol.upper()
    return MOCK_STOCK_PRICES.get(symbol, None)

def buy_stock(symbol: str, shares: int):
    symbol = symbol.upper()
    price = get_stock_price(symbol)
    if price is None:
        return False, "Stock symbol not found."
    cost = shares * price
    if cost > st.session_state.cash:
        return False, f"Insufficient funds. You need ${cost:.2f} but have only ${st.session_state.cash:.2f}."
    # Update portfolio
    if symbol in st.session_state.portfolio:
        current = st.session_state.portfolio[symbol]
        total_shares = current["shares"] + shares
        # Weighted avg price
        avg_price = ((current["avg_price"] * current["shares"]) + cost) / total_shares
        st.session_state.portfolio[symbol] = {"shares": total_shares, "avg_price": avg_price}
    else:
        st.session_state.portfolio[symbol] = {"shares": shares, "avg_price": price}
    st.session_state.cash -= cost
    if not st.session_state.quests["first_stock"]:
        st.session_state.quests["first_stock"] = True
    return True, f"Bought {shares} shares of {symbol} at ${price:.2f} each, costing ${cost:.2f}."

def portfolio_summary():
    total_value = 0.0
    lines = []
    for symbol, data in st.session_state.portfolio.items():
        price = get_stock_price(symbol)
        value = price * data["shares"] if price else 0
        total_value += value
        lines.append(f"{symbol}: {data['shares']} shares, Avg price: ${data['avg_price']:.2f}, Current price: ${price if price else 'N/A'}, Value: ${value:.2f}")
    return lines, total_value

def complete_quest(quest_key: str):
    if quest_key in st.session_state.quests:
        st.session_state.quests[quest_key] = True

# ---------- Streamlit UI ----------

st.title("InvestifyKids - FinTech Learning App")

if not st.session_state.registered:
    st.header("Register")
    name = st.text_input("Enter your name")
    role = st.selectbox("Select your role", ["Child", "Parent"])
    if st.button("Register"):
        if not name.strip():
            st.error("Name cannot be empty!")
        else:
            register_user(name, role)
else:
    st.sidebar.write(f"Hello, {st.session_state.name} ({st.session_state.role})")
    st.sidebar.write(f"Cash Balance: ${st.session_state.cash:.2f}")

    st.header("Explain Financial Terms")
    term = st.text_input("Enter a financial term to learn about it")
    if st.button("Explain Term"):
        if not term.strip():
            st.error("Please enter a term!")
        else:
            explanation = explain_term(term)
            st.info(explanation)
            if term.lower() == "bond":
                complete_quest("learn_bond")

    st.header("Check Stock Price")
    stock_symbol = st.text_input("Enter stock symbol (e.g. AAPL)")
    if st.button("Check Price"):
        price = get_stock_price(stock_symbol)
        if price is None:
            st.error("Stock symbol not found.")
        else:
            st.success(f"The current price of {stock_symbol.upper()} is ${price:.2f}")
            complete_quest("check_price")

    st.header("Buy Stocks")
    buy_symbol = st.text_input("Stock symbol to buy", key="buy_symbol")
    buy_shares = st.number_input("Number of shares", min_value=1, step=1, key="buy_shares")
    if st.button("Buy"):
        if not buy_symbol.strip():
            st.error("Please enter stock symbol.")
        else:
            success, msg = buy_stock(buy_symbol, buy_shares)
            if success:
                st.success(msg)
            else:
                st.error(msg)

    st.header("Your Portfolio")
    if len(st.session_state.portfolio) == 0:
        st.write("You have not purchased any stocks yet.")
    else:
        lines, total_value = portfolio_summary()
        for line in lines:
            st.write(line)
        st.write(f"Total portfolio value: ${total_value:.2f}")
        st.write(f"Cash remaining: ${st.session_state.cash:.2f}")

    st.header("Quests and Achievements")
    quest_texts = {
        "register": "Complete registration",
        "first_stock": "Buy your first stock",
        "learn_bond": "Learn what a bond is",
        "check_price": "Check stock price",
    }
    for key, text in quest_texts.items():
        status = "✅ Completed" if st.session_state.quests.get(key) else "❌ Incomplete"
        st.write(f"{text}: {status}")

    st.write("---")
    st.write(f"Session started at: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
